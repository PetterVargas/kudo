---
title: Mecanismos de Cifrado en Reposo y en Tr谩nsito
description: Controles criptogr谩ficos para proteger datos almacenados y transmitidos.
---

## 1. Objetivo y Alcance

### 1.1 Objetivo
Establecer los mecanismos de cifrado obligatorios para proteger la confidencialidad e integridad de los datos de DivisionCero, tanto en reposo como en tr谩nsito, asegurando el cumplimiento de est谩ndares de seguridad y regulaciones aplicables.

### 1.2 Alcance
Este documento aplica a:
- Todos los sistemas de informaci贸n de DivisionCero
- Bases de datos y sistemas de almacenamiento
- Comunicaciones de red internas y externas
- Aplicaciones SaaS desarrolladas internamente
- Servicios en la nube (AWS, Azure, GCP)
- Dispositivos m贸viles y endpoints

## 2. Marco Regulatorio y Normativo

### 2.1 Est谩ndares de Referencia
- **ISO 27001:2022** - Controles A.10.1.1, A.10.1.2
- **NIST Cybersecurity Framework** - PR.DS-1, PR.DS-2
- **PCI DSS v4.0** - Requisitos 3 y 4
- **GDPR** - Art铆culo 32 (Seguridad del tratamiento)
- **FIPS 140-2** - Est谩ndares criptogr谩ficos

## 3. Clasificaci贸n y Requisitos de Cifrado

### 3.1 Datos Clasificados

| Clasificaci贸n | Cifrado en Reposo | Cifrado en Tr谩nsito | Gesti贸n de Claves |
|---------------|-------------------|---------------------|-------------------|
| **P煤blicos** | Opcional | TLS 1.2+ | Gesti贸n b谩sica |
| **Internos** | AES-256 | TLS 1.3 | HSM/KMS |
| **Confidenciales** | AES-256 + ECC | TLS 1.3 + mTLS | HSM obligatorio |
| **Cr铆ticos** | AES-256 + PQC* | TLS 1.3 + mTLS + PFS | HSM + Split knowledge |

*PQC: Post-Quantum Cryptography (preparaci贸n futura)

## 4. Cifrado en Reposo

### 4.1 Requisitos Generales
- **Algoritmos aprobados**: AES-256, ChaCha20-Poly1305
- **Modos de operaci贸n**: GCM, CCM para autenticaci贸n
- **Gesti贸n de claves**: Rotaci贸n autom谩tica cada 12 meses
- **Separaci贸n**: Claves y datos almacenados por separado

### 4.2 Implementaci贸n por Tipo de Almacenamiento

#### 4.2.1 Bases de Datos
```sql
-- Ejemplo configuraci贸n PostgreSQL
-- Transparent Data Encryption (TDE)
ALTER SYSTEM SET shared_preload_libraries = 'pg_tde';
ALTER SYSTEM SET pg_tde.keyring_configuration = 'aws-kms';
```

#### 4.2.2 Sistemas de Archivos
- **Linux**: dm-crypt + LUKS2
- **Windows**: BitLocker con TPM 2.0
- **Servidores**: Cifrado a nivel de volumen

#### 4.2.3 Almacenamiento en la Nube
```yaml
# AWS S3 Bucket Encryption
aws_s3_bucket_server_side_encryption_configuration:
  rule:
    apply_server_side_encryption_by_default:
      sse_algorithm: "aws:kms"
      kms_master_key_id: "arn:aws:kms:region:account:key/key-id"
```

### 4.3 Configuraci贸n de Aplicaciones SaaS

#### 4.3.1 Base de Datos Principal (CRM/ERP)
```javascript
// Configuraci贸n de cifrado a nivel de aplicaci贸n
const crypto = require('crypto');
const algorithm = 'aes-256-gcm';

function encryptData(text, key) {
  const iv = crypto.randomBytes(16);
  const cipher = crypto.createCipher(algorithm, key, iv);
  
  let encrypted = cipher.update(text, 'utf8', 'hex');
  encrypted += cipher.final('hex');
  
  const authTag = cipher.getAuthTag();
  return {
    encrypted,
    iv: iv.toString('hex'),
    authTag: authTag.toString('hex')
  };
}
```

## 5. Cifrado en Tr谩nsito

### 5.1 Protocolos Aprobados

#### 5.1.1 Comunicaciones Web
- **TLS 1.3** (obligatorio para nuevos sistemas)
- **TLS 1.2** (permitido hasta diciembre 2024)
- **Cipher suites aprobadas**:
  - TLS_AES_256_GCM_SHA384
  - TLS_CHACHA20_POLY1305_SHA256
  - TLS_AES_128_GCM_SHA256

#### 5.1.2 Configuraci贸n Nginx
```nginx
# Configuraci贸n segura TLS
ssl_protocols TLSv1.2 TLSv1.3;
ssl_ciphers ECDHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-CHACHA20-POLY1305;
ssl_prefer_server_ciphers off;
ssl_session_timeout 1d;
ssl_session_cache shared:SSL:50m;
ssl_stapling on;
ssl_stapling_verify on;

# HSTS
add_header Strict-Transport-Security "max-age=63072000" always;
```

### 5.2 Comunicaciones Internas

#### 5.2.1 APIs y Microservicios
- **mTLS** obligatorio para comunicaci贸n entre servicios
- **JWT** con RS256/ES256 para autenticaci贸n
- **Perfect Forward Secrecy** habilitado

#### 5.2.2 VPN Corporativa
- **IPSec** con IKEv2
- **Algoritmos**: AES-256 + SHA-256
- **DH Group**: Group 19 (256-bit ECC) o superior

## 6. Gesti贸n de Claves Criptogr谩ficas

### 6.1 Arquitectura de KMS

```mermaid
graph TB
    A[HSM Principal] --> B[KMS Regional]
    B --> C[Claves de Cifrado de Datos]
    B --> D[Claves de Cifrado de Claves]
    
    E[Aplicaciones] --> F[SDK Cifrado]
    F --> B
    
    G[Rotaci贸n Autom谩tica] --> B
    H[Auditor铆a] --> I[Logs de Acceso]
    B --> I
```

### 6.2 Ciclo de Vida de Claves

| Fase | Descripci贸n | Responsable | Frecuencia |
|------|-------------|-------------|------------|
| **Generaci贸n** | Creaci贸n con HSM | Equipo Seguridad | Por demanda |
| **Distribuci贸n** | Entrega segura | Automatizada | Inmediata |
| **Almacenamiento** | HSM/KMS seguro | Infraestructura | Continua |
| **Rotaci贸n** | Cambio autom谩tico | Sistema | 12 meses |
| **Revocaci贸n** | Invalidaci贸n | CISO/Admin | Inmediata |
| **Destrucci贸n** | Eliminaci贸n segura | Automatizada | Post-retenci贸n |

### 6.3 Configuraci贸n AWS KMS
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "DivisionCeroKMSPolicy",
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::ACCOUNT:role/DivisionCero-EncryptionRole"
      },
      "Action": [
        "kms:Encrypt",
        "kms:Decrypt",
        "kms:ReEncrypt*",
        "kms:GenerateDataKey*",
        "kms:DescribeKey"
      ],
      "Resource": "*",
      "Condition": {
        "StringEquals": {
          "kms:EncryptionContext:Department": "Engineering"
        }
      }
    }
  ]
}
```

## 7. Algoritmos y Configuraciones Espec铆ficas

### 7.1 Algoritmos Aprobados

#### 7.1.1 Cifrado Sim茅trico
- **AES-256**: Datos en reposo y comunicaciones
- **ChaCha20-Poly1305**: Alternativa m贸vil/IoT
- **AES-128**: Solo para datos no sensibles

#### 7.1.2 Cifrado Asim茅trico
- **RSA-2048**: M铆nimo aceptable (fase out 2025)
- **RSA-4096**: Recomendado para nuevos sistemas
- **ECC P-256**: Eficiencia computacional
- **ECC P-384**: Datos cr铆ticos

### 7.2 Funciones Hash
- **SHA-256**: Est谩ndar para integridad
- **SHA-3**: Sistemas de alta seguridad
- **BLAKE2b**: Aplicaciones de alto rendimiento

## 8. Implementaci贸n por Dominio Tecnol贸gico

### 8.1 Aplicaciones Web (React/Node.js)
```javascript
// Configuraci贸n crypto-js para frontend
import CryptoJS from 'crypto-js';

const encryptionConfig = {
  keySize: 256 / 32,
  ivSize: 128 / 32,
  mode: CryptoJS.mode.GCM,
  padding: CryptoJS.pad.NoPadding
};

function encryptSensitiveData(data, passphrase) {
  const salt = CryptoJS.lib.WordArray.random(256 / 8);
  const key = CryptoJS.PBKDF2(passphrase, salt, {
    keySize: encryptionConfig.keySize,
    iterations: 100000
  });
  
  const iv = CryptoJS.lib.WordArray.random(encryptionConfig.ivSize);
  const encrypted = CryptoJS.AES.encrypt(data, key, {
    iv: iv,
    mode: encryptionConfig.mode
  });
  
  return {
    salt: salt.toString(CryptoJS.enc.Hex),
    iv: iv.toString(CryptoJS.enc.Hex),
    encrypted: encrypted.toString()
  };
}
```

### 8.2 Bases de Datos (PostgreSQL)
```sql
-- Extensi贸n de cifrado pgcrypto
CREATE EXTENSION IF NOT EXISTS pgcrypto;

-- Tabla con campos cifrados
CREATE TABLE usuarios_datos_sensibles (
    id SERIAL PRIMARY KEY,
    email VARCHAR(255),
    documento_cifrado BYTEA,
    telefono_cifrado BYTEA,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Funci贸n para insertar datos cifrados
CREATE OR REPLACE FUNCTION insertar_usuario_seguro(
    p_email VARCHAR(255),
    p_documento TEXT,
    p_telefono TEXT,
    p_clave TEXT
)
RETURNS INTEGER AS $$
DECLARE
    nuevo_id INTEGER;
BEGIN
    INSERT INTO usuarios_datos_sensibles (
        email,
        documento_cifrado,
        telefono_cifrado
    )
    VALUES (
        p_email,
        pgp_sym_encrypt(p_documento, p_clave),
        pgp_sym_encrypt(p_telefono, p_clave)
    )
    RETURNING id INTO nuevo_id;
    
    RETURN nuevo_id;
END;
$$ LANGUAGE plpgsql;
```

### 8.3 Microservicios (Docker/Kubernetes)
```yaml
# Configuraci贸n de secretos cifrados en K8s
apiVersion: v1
kind: Secret
metadata:
  name: divisioncero-encryption-keys
  namespace: production
type: Opaque
data:
  database-key: <base64-encoded-key>
  api-secret: <base64-encoded-secret>
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: divisioncero-api
spec:
  template:
    spec:
      containers:
      - name: api
        image: divisioncero/api:latest
        env:
        - name: ENCRYPTION_KEY
          valueFrom:
            secretKeyRef:
              name: divisioncero-encryption-keys
              key: database-key
        volumeMounts:
        - name: tls-certs
          mountPath: /etc/tls
          readOnly: true
      volumes:
      - name: tls-certs
        secret:
          secretName: divisioncero-tls-certs
```

## 9. Monitoreo y Alertas

### 9.1 M茅tricas de Seguridad Criptogr谩fica
- **Uso de algoritmos prohibidos**: Alerta cr铆tica
- **Claves pr贸ximas a expirar**: 30 d铆as antes
- **Fallos de cifrado/descifrado**: Alerta inmediata
- **Accesos an贸malos a KMS**: Investigaci贸n autom谩tica

### 9.2 Dashboard de Monitoreo
```javascript
// M茅tricas Prometheus para cifrado
const prometheus = require('prom-client');

const encryptionMetrics = {
  operationsTotal: new prometheus.Counter({
    name: 'encryption_operations_total',
    help: 'Total encryption operations',
    labelNames: ['operation', 'algorithm', 'status']
  }),
  
  keyRotationGauge: new prometheus.Gauge({
    name: 'encryption_key_age_days',
    help: 'Age of encryption keys in days',
    labelNames: ['key_id', 'key_type']
  }),
  
  tlsConnectionsGauge: new prometheus.Gauge({
    name: 'tls_connections_active',
    help: 'Active TLS connections by version',
    labelNames: ['tls_version', 'cipher_suite']
  })
};
```

## 10. Procedimientos Operacionales

### 10.1 Rotaci贸n de Claves
```bash
#!/bin/bash
# Script de rotaci贸n de claves automatizada

set -euo pipefail

ENVIRONMENT=${1:-staging}
KMS_KEY_ID="arn:aws:kms:us-east-1:ACCOUNT:key/KEY-ID"

echo "Iniciando rotaci贸n de claves para entorno: $ENVIRONMENT"

# 1. Crear nueva versi贸n de clave
aws kms create-key \
  --policy file://kms-policy.json \
  --description "DivisionCero $ENVIRONMENT encryption key $(date +%Y%m%d)" \
  --key-usage ENCRYPT_DECRYPT \
  --key-spec SYMMETRIC_DEFAULT

# 2. Actualizar alias
NEW_KEY_ID=$(aws kms list-keys --query "Keys[0].KeyId" --output text)
aws kms update-alias \
  --alias-name "alias/divisioncero-$ENVIRONMENT" \
  --target-key-id "$NEW_KEY_ID"

# 3. Notificar a equipos
curl -X POST "$SLACK_WEBHOOK" \
  -H 'Content-type: application/json' \
  --data "{\"text\":\" Rotaci贸n de claves completada para $ENVIRONMENT\"}"

echo "Rotaci贸n completada. Nueva clave: $NEW_KEY_ID"
```

### 10.2 Verificaci贸n de Conformidad
```python
#!/usr/bin/env python3
"""
Script de verificaci贸n de conformidad criptogr谩fica
"""

import ssl
import socket
import subprocess
import json
from datetime import datetime

def verificar_tls_endpoint(hostname, port=443):
    """Verifica la configuraci贸n TLS de un endpoint"""
    context = ssl.create_default_context()
    
    try:
        with socket.create_connection((hostname, port), timeout=10) as sock:
            with context.wrap_socket(sock, server_hostname=hostname) as ssock:
                cipher = ssock.cipher()
                cert = ssock.getpeercert()
                
                return {
                    'hostname': hostname,
                    'tls_version': ssock.version(),
                    'cipher_suite': cipher[0] if cipher else None,
                    'certificate_expires': cert.get('notAfter'),
                    'compliant': cipher[0] in APPROVED_CIPHERS if cipher else False
                }
    except Exception as e:
        return {
            'hostname': hostname,
            'error': str(e),
            'compliant': False
        }

def verificar_base_datos():
    """Verifica configuraci贸n de cifrado en BD"""
    try:
        result = subprocess.run([
            'psql', '-h', 'localhost', '-U', 'postgres',
            '-c', 'SHOW ssl;'
        ], capture_output=True, text=True)
        
        return {
            'ssl_enabled': 'on' in result.stdout,
            'compliant': 'on' in result.stdout
        }
    except Exception as e:
        return {'error': str(e), 'compliant': False}

# Constantes de conformidad
APPROVED_CIPHERS = [
    'TLS_AES_256_GCM_SHA384',
    'TLS_CHACHA20_POLY1305_SHA256',
    'ECDHE-RSA-AES256-GCM-SHA384'
]

if __name__ == "__main__":
    endpoints = [
        'api.divisioncero.com',
        'app.divisioncero.com',
        'admin.divisioncero.com'
    ]
    
    report = {
        'timestamp': datetime.now().isoformat(),
        'endpoints': [],
        'database': verificar_base_datos()
    }
    
    for endpoint in endpoints:
        report['endpoints'].append(verificar_tls_endpoint(endpoint))
    
    print(json.dumps(report, indent=2))
```

## 11. Cumplimiento y Auditor铆a

### 11.1 Controles de Auditor铆a
- **Trimestral**: Revisi贸n de configuraciones de cifrado
- **Semestral**: Penetration testing de implementaciones
- **Anual**: Auditor铆a externa de gesti贸n de claves
- **Continuo**: Monitoreo automatizado de compliance

### 11.2 Documentaci贸n de Evidencias
```yaml
# Template de evidencia de cumplimiento
evidencia_cifrado:
  fecha: "2024-03-20"
  auditor: "equipo-seguridad@divisioncero.com"
  alcance:
    - "Aplicaciones web principales"
    - "Bases de datos productivas"
    - "Comunicaciones inter-servicios"
  
  hallazgos:
    - control: "A.10.1.1 - Pol铆tica de uso de controles criptogr谩ficos"
      estado: "CUMPLE"
      evidencia: "Documento mecanismos-cifrado.mdx v2.1.0"
    
    - control: "A.10.1.2 - Gesti贸n de llaves"
      estado: "CUMPLE"
      evidencia: "AWS KMS configurado con rotaci贸n autom谩tica"
  
  excepciones:
    - sistema: "Sistema legacy CRM v1.0"
      justificacion: "Migraci贸n programada Q2 2024"
      plan_mitigacion: "Segmentaci贸n de red + monitoreo adicional"
```

## 12. Plan de Migraci贸n Post-Quantum

### 12.1 Preparaci贸n PQC
En preparaci贸n para la era post-quantum, DivisionCero est谩 evaluando:

- **CRYSTALS-Kyber**: Encapsulaci贸n de claves
- **CRYSTALS-Dilithium**: Firmas digitales
- **SPHINCS+**: Firmas sin estructuras matem谩ticas

### 12.2 Cronograma de Adopci贸n
- **2024 Q3**: Evaluaci贸n de librer铆as PQC
- **2024 Q4**: Implementaci贸n h铆brida (cl谩sico + PQC)
- **2025 Q2**: Migraci贸n gradual sistemas cr铆ticos
- **2026**: Adopci贸n completa est谩ndares NIST

## 13. Roles y Responsabilidades

| Rol | Responsabilidades Criptogr谩ficas |
|-----|-----------------------------------|
| **CISO** | Aprobaci贸n de pol铆ticas, supervisi贸n general |
| **Arquitecto de Seguridad** | Dise帽o de soluciones, est谩ndares t茅cnicos |
| **DevSecOps** | Implementaci贸n, automatizaci贸n, CI/CD |
| **Administradores de Sistema** | Configuraci贸n de infraestructura |
| **Desarrolladores** | Implementaci贸n en aplicaciones |
| **Auditores Internos** | Verificaci贸n de cumplimiento |

## 14. Contactos y Escalamiento

### 14.1 Equipo de Criptograf铆a
- **L铆der T茅cnico**: crypto-lead@divisioncero.com
- **Escalamiento 24/7**: security-ops@divisioncero.com
- **Incidentes Cr铆ticos**: +57-300-CRYPTO (Whatsapp)

### 14.2 Matriz de Escalamiento

| Severidad | Tiempo Respuesta | Contacto |
|-----------|------------------|----------|
| **Cr铆tica** | 15 minutos | CISO + CTO |
| **Alta** | 2 horas | L铆der Seguridad |
| **Media** | 8 horas | Equipo DevSecOps |
| **Baja** | 24 horas | Ticket Jira |
